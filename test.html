<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Survey Dashboard</title>

<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/maps/modules/map.js"></script>
<script src="https://code.highcharts.com/mapdata/custom/europe.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/offline-exporting.js"></script>

<script>
Highcharts.setOptions({plotOptions:{series:{animation:{duration:500}}}});
</script>

<!-- palette & logo helpers -->
<script>
const barPalette={
  1:['#355582'],
  2:['#355582','#005F2F'],
  3:['#355582','#9ca2a9','#005F2F'],
  4:['#355582','#9ca2a9','#4d853d','#005F2F'],
  5:['#355582','#9ca2a9','#5479b3','#4d853d','#005F2F'],
  6:['#003c8f','#416ea8','#6f90c0','#66bb6a','#4d853d','#005F2F']
};
function barColor(i,n){return barPalette[Math.min(n,6)][i];}

var logoURL='https://www.eurofound.europa.eu/themes/custom/eurofound/logo.svg';
function addLogo(ch){
  var w=90,h=28,x=ch.chartWidth-w-10,y=ch.chartHeight-h-10;
  if(ch.customLogo) ch.customLogo.destroy();
  ch.customLogo=ch.renderer.image(logoURL,x,y,w,h).css({opacity:0.8}).add();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--blue:#355582;--grey:#9ca2a9;--border:#d8d8d8;font-size:14px}
body{font-family:'Inter',Arial,sans-serif;margin:1.5rem;max-width:960px}
h1{margin:0 0 .75rem;font-size:1.1rem;font-weight:600}
label{display:block;margin:0 0 1rem;font-weight:600}
select{width:100%;padding:.4rem;border:1px solid var(--border);border-radius:4px;font:inherit}
button{font:inherit;padding:.45rem .9rem;border:1px solid var(--border);border-radius:4px;background:#eee;margin-right:.6rem;cursor:pointer}
button:disabled{opacity:.4;cursor:not-allowed}
.hidden{display:none!important}
#tabs{display:flex;gap:1.5rem;margin:0 0 1rem;font-weight:600}
.tab{display:flex;align-items:center;gap:.4rem;color:var(--grey);cursor:pointer}
.tab.active{color:var(--blue);border-bottom:3px solid var(--blue)}
.tab svg{width:18px;height:18px;fill:currentColor}
#container{width:100%;height:520px;margin-bottom:1rem}
footer{margin-top:.75rem}footer img{height:36px}
</style>
</head>
<body>

<h1>European Public-Opinion Snapshot</h1>

<label>Select question <select id="qSel"></select></label>
<label id="cBlock">Select country <select id="cSel" multiple size="5"></select></label>

<label id="fBlockMain">Filter by <select id="fSelMain"></select></label>

<label id="fBlockFilt" class="hidden">Filter by
  <select id="fSelFilt" multiple size="5"></select>
</label>

<label id="rBlock" class="hidden">Select response
  <select id="rSel" multiple size="5"></select>
</label>

<div id="tabs">
  <span class="tab active" data-view="bar"><svg viewBox="0 0 24 24"><rect x="3" y="9" width="6" height="12"/><rect x="10" y="3" width="6" height="18"/><rect x="17" y="13" width="6" height="8"/></svg>Country bar</span>
  <span class="tab" data-view="filter"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="6" height="6"/><rect x="3" y="10" width="6" height="6"/><rect x="3" y="17" width="6" height="6"/></svg>Filter bar</span>
  <span class="tab" data-view="map"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>Map</span>
</div>

<div id="container"></div>

<div style="margin-bottom:1rem">
  <button id="dlData" disabled>Download data (CSV)</button>
  <button id="dlImg"  disabled>Download image (PNG)</button>
</div>

<footer><img src="https://www.eurofound.europa.eu/themes/custom/eurofound/logo.svg" alt="Eurofound"></footer>

<script>
/* ---------- utilities ---------- */
function tidy(r){var o={}; for(var k in r) o[k.trim()]=r[k]; return o;}
function layout(n){
  if(n>20) return{h:700,p:.03,g:.05,pt:16,labels:false};
  if(n>8)  return{h:520,p:.05,g:.1 ,pt:null,labels:false};
  return     {h:520,p:.1 ,g:.2 ,pt:null,labels:true};
}
function enableExports(ch){
  dlData.disabled=dlImg.disabled=!ch;
  if(ch){
    dlData.onclick=function(){ch.downloadCSV();};
    dlImg.onclick =function(){ch.exportChartLocal({type:'image/png',filename:'survey-'+Date.now()});};
  }
}

/* ---------- load CSV ---------- */
var CSV='https://coral-johna-20.tiiny.site/Dashboard_data.csv';
Papa.parse(CSV,{
  download:true,header:true,dynamicTyping:true,
  complete:function(res){
    var rows=res.data.map(tidy).filter(function(r){return r.Question&&r.Country&&r.Filters&&r.Responses&&r.Result;});
    var qList=[].filter.call(rows,function(r,i,a){return a.findIndex(function(x){return x.Question.trim()===r.Question.trim();})===i}).map(function(r){return r.Question.trim();});
    var cList=[].filter.call(rows,function(r,i,a){return a.findIndex(function(x){return x.Country.trim()===r.Country.trim();})===i}).map(function(r){return r.Country.trim();}).sort();
    var filtList=[].filter.call(rows,function(r,i,a){return a.findIndex(function(x){return x.Filters.trim()===r.Filters.trim();})===i}).map(function(r){return r.Filters.trim();}).sort();
    function respFor(q){return [].filter.call(rows,function(r,i,a){return r.Question.trim()===q && a.findIndex(function(x){return x.Question.trim()===q && x.Responses.trim()===r.Responses.trim();})===i;}).map(function(r){return r.Responses.trim();}).sort();}

    /* build selectors */
    qSel.innerHTML=qList.map(function(q){return'<option>'+q+'</option>';}).join('');
    cSel.innerHTML=['<option value="__all__">Select all</option>'].concat(cList.map(function(c){return'<option>'+c+'</option>';}).join('')).join('');
    fSelMain.innerHTML=['<option value="__all__">All filters</option>'].concat(filtList.map(function(f){return'<option>'+f+'</option>';}).join('')).join('');
    fSelFilt.innerHTML=filtList.map(function(f){return'<option>'+f+'</option>';}).join('');
    rSel.innerHTML=respFor(qSel.value).map(function(r){return'<option>'+r+'</option>';}).join('');

    /* defaults */
    cSel.options[0].selected=true;
    [].forEach.call(fSelFilt.options,function(o){o.selected=true;});
    rSel.options[0].selected=true;
    var selResponsesMap=new Set([rSel.value]);

    /* state */
    var view='bar',chart;
    var selCountries=new Set(), selFilterMain='__all__', selFilterFilt=new Set(filtList);

    /* helper toggler */
    function toggle(sel,cb){
      sel.addEventListener('mousedown',function(e){
        if(e.target.tagName!=='OPTION')return;
        e.preventDefault(); e.target.selected=!e.target.selected; cb();});
    }

    /* update fns */
    function updateCountries(){
      if(cSel.multiple){
        if(cSel.options[0].selected){[].forEach.call(cSel.options,function(o){o.selected=true;}); selCountries.clear();}
        else selCountries=new Set([].filter.call(cSel.selectedOptions,function(o){return o.value!=='__all__';}).map(function(o){return o.value;}));
      }else selCountries=new Set([cSel.value]);
      draw();
    }
    toggle(cSel,updateCountries); cSel.addEventListener('change',updateCountries);

    fSelMain.onchange=function(){selFilterMain=fSelMain.value; if(view!=='filter')draw();};
    function updateFilterTab(){selFilterFilt=new Set([].map.call(fSelFilt.selectedOptions,function(o){return o.value;})); draw();}
    toggle(fSelFilt,updateFilterTab); fSelFilt.addEventListener('change',updateFilterTab);

    function updateResp(){
      selResponsesMap=new Set([].map.call(rSel.selectedOptions,function(o){return o.value;}));
      if(selResponsesMap.size===0) selResponsesMap.add(rSel.options[0].value);
      if(view==='map')draw();
    }
    toggle(rSel,updateResp); rSel.addEventListener('change',updateResp);

    qSel.onchange=function(){
      rSel.innerHTML=respFor(qSel.value).map(function(r){return'<option>'+r+'</option>';}).join('');
      rSel.options[0].selected=true; selResponsesMap=new Set([rSel.options[0].value]); draw();
    };

    /* tab switching */
    [].forEach.call(document.querySelectorAll('.tab'),function(t){
      t.onclick=function(){
        view=t.getAttribute('data-view');
        [].forEach.call(document.querySelectorAll('.tab'),function(x){x.classList.toggle('active',x===t);});
        if(view==='bar'){
          cBlock.classList.remove('hidden'); fBlockMain.classList.remove('hidden'); rBlock.classList.add('hidden'); fBlockFilt.classList.add('hidden');
          cSel.multiple=true; cSel.size=5;
        }else if(view==='filter'){
          cBlock.classList.remove('hidden'); fBlockMain.classList.add('hidden'); rBlock.classList.add('hidden'); fBlockFilt.classList.remove('hidden');
          cSel.multiple=false; cSel.size=1;
        }else{
          cBlock.classList.add('hidden'); fBlockMain.classList.remove('hidden'); rBlock.classList.remove('hidden'); fBlockFilt.classList.add('hidden');
        }
        draw();
      };
    });

    /* titles */
    function barTitle(){return qSel.value+' ('+(selFilterMain==='__all__'?'All filters':selFilterMain)+')';}
    function filtTitle(){return qSel.value+' ('+cSel.value+')';}
    function mapTitle(){return qSel.value+' ('+(selFilterMain==='__all__'?'All filters':selFilterMain)+') â€“ '+Array.from(selResponsesMap).join(', ');}

    /* series builder */
    function buildSeries(catArr,reps,getVal){
      var lay=layout(catArr.length);
      var series=reps.map(function(resp,i){
        return{
          name:resp,
          color:barColor(i,reps.length),
          data:catArr.map(function(ct){return getVal(resp,ct);}),
          dataLabels:lay.labels?{
            enabled:true,inside:true,align:'right',crop:false,overflow:'allow',
            formatter:function(){return this.y?this.y.toFixed(0)+'%':'';},
            style:{fontSize:'13px',fontWeight:'700',color:'#fff',textOutline:'none'},x:-3
          }:{enabled:false}
        };
      });
      return{series:series,lay:lay};
    }

    /* Country bar */
    function drawCountryBar(){
      var q=qSel.value;
      var reps=respFor(q);
      var cats=selCountries.size?Array.from(selCountries):cList.slice();
      function val(r,ct){var o=rows.filter(function(x){return x.Question.trim()===q && x.Country.trim()===ct && x.Responses.trim()===r && (selFilterMain==='__all__' || x.Filters.trim()===selFilterMain);})[0]; return o?o.Result:0;}
      var totals=cats.map(function(ct){return reps.reduce(function(s,r){return s+val(r,ct);},0);});
      var visCats=cats.filter(function(_,i){return totals[i]>0;});
      var obj=buildSeries(visCats,reps,val); var series=obj.series,lay=obj.lay;

      chart=Highcharts.chart('container',{
        chart:{type:'bar',height:lay.h},
        title:{text:barTitle()},
        xAxis:{categories:visCats},
        yAxis:{min:0,title:{text:'%'}},
        tooltip:{useHTML:true,width:250,style:{fontSize:'15px'},
            headerFormat:'<span style="font-size:15px">{point.key}</span><br>',
            pointFormat:'<span style="color:{series.color}">â– </span> {series.name}: <b>{point.y:.0f}%</b><br>'},
        plotOptions:{series:{stacking:'normal',pointPadding:lay.p,groupPadding:lay.g,pointWidth:lay.pt}},
        series:series,
        events:{load:function(){addLogo(this);},redraw:function(){addLogo(this);}}
      });
    }

    /* Filter bar */
    function drawFilterBar(){
      var q=qSel.value,c=cSel.value,reps=respFor(q),filts=Array.from(selFilterFilt);
      function val(r,fl){var o=rows.filter(function(x){return x.Question.trim()===q&&x.Country.trim()===c&&x.Filters.trim()===fl&&x.Responses.trim()===r;})[0];return o?o.Result:0;}
      var totals=filts.map(function(fl){return reps.reduce(function(s,r){return s+val(r,fl);},0);});
      var vis=filts.filter(function(_,i){return totals[i]>0;});
      if(!vis.length){chart=Highcharts.chart('container',{title:{text:'Select filters'},series:[]});return;}
      var obj=buildSeries(vis,reps,val); var series=obj.series,lay=obj.lay;

      chart=Highcharts.chart('container',{
        chart:{type:'bar',height:lay.h},
        title:{text:filtTitle()},
        xAxis:{categories:vis},
        yAxis:{min:0,title:{text:'%'}},
        tooltip:{useHTML:true,width:250,style:{fontSize:'15px'},
          headerFormat:'<span style="font-size:15px">{point.key}</span><br>',
          pointFormat:'<span style="color:{series.color}">â– </span> {series.name}: <b>{point.y:.0f}%</b><br>'},
        plotOptions:{series:{stacking:'normal',pointPadding:lay.p,groupPadding:lay.g,pointWidth:lay.pt}},
        series:series,
        events:{load:function(){addLogo(this);},redraw:function(){addLogo(this);}}
      });
    }

    /* Map */
    function drawMap(){
      var q=qSel.value,reps=respFor(q),byC={};
      rows.forEach(function(r){
        if(r.Question.trim()!==q) return;
        if(!(selFilterMain==='__all__' || r.Filters.trim()===selFilterMain)) return;
        var c=r.Country.trim(),resp=r.Responses.trim();
        if(!byC[c])byC[c]={tot:0,all:{}};
        if(selResponsesMap.has(resp))byC[c].tot+=r.Result;
        byC[c].all[resp]=r.Result;
      });
      var keys={}; Highcharts.maps['custom/europe'].features.forEach(function(f){keys[f.properties.name]=f.properties['hc-key'];});
      var data=Object.keys(byC).map(function(ct){return{'hc-key':keys[ct]||ct.slice(0,2).toLowerCase(),value:byC[ct].tot,name:ct,all:byC[ct].all};});
      var max=data.reduce(function(m,d){return Math.max(m,d.value);},0)||1;

      chart=Highcharts.mapChart('container',{
        title:{text:mapTitle()},
        chart:{map:'custom/europe',animation:false},
        colorAxis:{min:0,max:max,tickAmount:6,stops:[[0,'#355582'],[0.5,'#9ca2a9'],[1,'#005F2F']]},
        legend:{title:{text:'%'},layout:'vertical',align:'left',verticalAlign:'bottom',floating:true,background:'#fff',borderWidth:1},
        tooltip:{useHTML:true,width:260,
          formatter:function(){
            var vals=this.point.all||{},maxR=Math.max.apply(null,Object.values(vals))||1,html='<div style="width:260px;font-size:14px"><strong style="font-size:1.05em">'+this.point.name+'</strong><br>';
            reps.forEach(function(r,i){
              var v=vals[r]||0,w=maxR?100*v/maxR:0;
              html+='<div style="margin-bottom:4px">'+r+'<br><span style="display:inline-block;background:'+barColor(i,reps.length)+';width:'+w+'%;height:10px"></span> <span style="font-size:.85em">'+v.toFixed(0)+'%</span></div>';
            });
            return html+'</div>';
          }},
        series:[{showInLegend:false,data:data,joinBy:['hc-key',0],animation:false}],
        mapNavigation:{enabled:true},
        events:{load:function(){addLogo(this);},redraw:function(){addLogo(this);}}
      });
    }

    /* top-level draw */
    function draw(){
      if(chart) chart.destroy();
      if(view==='bar')      drawCountryBar();
      else if(view==='filter') drawFilterBar();
      else                    drawMap();
      enableExports(chart);
    }

    draw(); /* initial render */
  }});
</script>
</body>
</html>
