<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Survey Dashboard</title>

<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/maps/modules/map.js"></script>
<script src="https://code.highcharts.com/mapdata/custom/europe.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/offline-exporting.js"></script>
<script>Highcharts.setOptions({plotOptions:{series:{animation:{duration:500}}}});</script>

<!-- palettes & logo -->
<script>
const barPalette={1:['#355582'],2:['#355582','#005F2F'],
3:['#355582','#9ca2a9','#005F2F'],
4:['#355582','#9ca2a9','#4d853d','#005F2F'],
5:['#355582','#9ca2a9','#5479b3','#4d853d','#005F2F'],
6:['#003c8f','#416ea8','#6f90c0','#66bb6a','#4d853d','#005F2F']};
const barColor=(i,n)=>barPalette[Math.min(n,6)][i];
const logoURL='https://www.eurofound.europa.eu/themes/custom/eurofound/logo.svg';
function addLogo(chart){
  const w=90,h=28,x=chart.chartWidth-w-10,y=chart.chartHeight-h-10;
  if(chart.customLogo) chart.customLogo.destroy();
  chart.customLogo=chart.renderer.image(logoURL,x,y,w,h).css({opacity:.8}).add();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--blue:#355582;--grey:#9ca2a9;--border:#d8d8d8;font-size:14px}
body{font-family:'Inter',Arial,sans-serif;margin:1.5rem;max-width:960px}
h1{margin:0 0 .75rem;font-size:1.1rem;font-weight:600}
label{display:block;margin:0 0 1rem;font-weight:600}
select{width:100%;padding:.4rem;border:1px solid var(--border);border-radius:4px;font:inherit}
button{font:inherit;padding:.45rem .9rem;border:1px solid var(--border);
       border-radius:4px;background:#eee;margin-right:.6rem;cursor:pointer}
button:disabled{opacity:.4;cursor:not-allowed}
.hidden{display:none!important}
#tabs{display:flex;gap:1.5rem;margin:0 0 1rem;font-weight:600}
.tab{display:flex;align-items:center;gap:.4rem;color:var(--grey);cursor:pointer}
.tab.active{color:var(--blue);border-bottom:3px solid var(--blue)}
.tab svg{width:18px;height:18px;fill:currentColor}
#container{width:100%;height:520px;margin-bottom:1rem}
footer{margin-top:.75rem}footer img{height:36px}
</style>
</head>

<body>
<h1>European Public-Opinion Snapshot</h1>

<label>Select question <select id="qSel"></select></label>
<label id="cBlock">Select country <select id="cSel" multiple size="5"></select></label>

<label id="fBlockMain">Filter by <select id="fSelMain"></select></label>

<label id="fBlockFilt" class="hidden">Filter by
  <select id="fSelFilt" multiple size="5"></select>
</label>

<label id="rBlock" class="hidden">Select response
  <select id="rSel" multiple size="5"></select>
</label>

<div id="tabs">
  <span class="tab active" data-view="bar">Country bar</span>
  <span class="tab" data-view="filter">Filter bar</span>
  <span class="tab" data-view="map">Map</span>
</div>

<div id="container"></div>

<div style="margin-bottom:1rem">
  <button id="dlData" disabled>Download data (CSV)</button>
  <button id="dlImg"  disabled>Download image (PNG)</button>
</div>
<footer><img src="https://www.eurofound.europa.eu/themes/custom/eurofound/logo.svg" alt="Eurofound"></footer>

<script>
const CSV='https://coral-johna-20.tiiny.site/Dashboard_data.csv';
const tidy=r=>{const o={};for(const k in r)o[k.trim()]=r[k];return o;};

const qSel=document.getElementById('qSel'),
      cSel=document.getElementById('cSel'),
      fSelMain=document.getElementById('fSelMain'),
      fSelFilt=document.getElementById('fSelFilt'),
      rSel=document.getElementById('rSel'),
      cBlock=document.getElementById('cBlock'),
      fBlockMain=document.getElementById('fBlockMain'),
      fBlockFilt=document.getElementById('fBlockFilt'),
      rBlock=document.getElementById('rBlock'),
      tabs=[...document.querySelectorAll('.tab')];

function enableExports(chart){
  dlData.disabled=dlImg.disabled=!chart;
  if(chart){
    dlData.onclick=()=>chart.downloadCSV();
    dlImg.onclick =()=>chart.exportChartLocal({type:'image/png',filename:'survey-'+Date.now()});
  }
}

Papa.parse(CSV,{download:true,header:true,dynamicTyping:true,complete:({data})=>{
  const rows=data.map(tidy)
                 .filter(r=>r.Question&&r.Country&&r.Filters&&r.Responses&&r.Result);
  const qList=[...new Set(rows.map(r=>r.Question.trim()))];
  const cList=[...new Set(rows.map(r=>r.Country.trim()))].sort();
  const filtList=[...new Set(rows.map(r=>r.Filters.trim()))].sort();
  const respFor=q=>[...new Set(
        rows.filter(r=>r.Question.trim()===q)
            .map(r=>r.Responses.trim())
      )].sort();

  /* populate */
  qSel.innerHTML = qList.map(q=>`<option>${q}</option>`).join('');
  
  cSel.innerHTML = ['<option value="__all__">All</option>',
                    ...cList.map(c=>`<option>${c}</option>`)].join('');
  fSelMain.innerHTML = ['<option value="__all__">All</option>',
                        ...filtList.map(f=>`<option>${f}</option>`)].join('');
  fSelFilt.innerHTML = filtList.map(f=>`<option>${f}</option>`).join('');
  rSel.innerHTML = respFor(qSel.value).map(r=>`<option>${r}</option>`).join('');

  /* defaults */
  cSel.options[0].selected = true;         // All countries
  fSelMain.selectedIndex   = 0;            // All filters
  [...fSelFilt.options].forEach(o=>o.selected=true);
  rSel.selectedIndex       = 0;

  let view='bar', chart;
  let selCountries=new Set(),
      selFilterMain='__all__',
      selFilterFilt=new Set(filtList),
      selResponses=new Set([rSel.value]);

  const toggle=(sel,cb)=>sel.addEventListener('mousedown',e=>{
    if(e.target.tagName!=='OPTION')return;
    e.preventDefault();
    e.target.selected=!e.target.selected;
    cb();
  });

  /* on-change handlers */
  qSel.onchange=()=>{
    rSel.innerHTML=respFor(qSel.value).map(r=>`<option>${r}</option>`).join('');
    rSel.selectedIndex=0;
    selResponses=new Set([rSel.value]);
    draw();
  };
  fSelMain.onchange=()=>{
    selFilterMain=fSelMain.value;
    if(view!=='filter')draw();
  };
  toggle(fSelFilt,()=>{
    selFilterFilt=new Set([...fSelFilt.selectedOptions].map(o=>o.value));
    draw();
  });
  toggle(cSel,()=>{
    if(cSel.options[0].selected){
      [...cSel.options].forEach(o=>o.selected=true);
      selCountries.clear();
    } else {
      selCountries=new Set(
        [...cSel.selectedOptions].map(o=>o.value).filter(v=>v!=='__all__')
      );
    }
    draw();
  });
  toggle(rSel,()=>{
    selResponses=new Set([...rSel.selectedOptions].map(o=>o.value));
    if(!selResponses.size){
      rSel.selectedIndex=0;
      selResponses=new Set([rSel.value]);
    }
    if(view==='map')draw();
  });

  /* tab switching */
  tabs.forEach(t=>t.onclick=()=>{
    view=t.dataset.view;
    tabs.forEach(x=>x.classList.toggle('active',x===t));
    if(view==='bar'){
      cBlock.classList.remove('hidden');
      fBlockMain.classList.remove('hidden');
      fBlockFilt.classList.add('hidden');
      rBlock.classList.add('hidden');
      fSelMain.selectedIndex=0;  // ensure “All” on bar tab
    }
    else if(view==='filter'){
      cBlock.classList.remove('hidden');
      fBlockMain.classList.add('hidden');
      fBlockFilt.classList.remove('hidden');
      rBlock.classList.add('hidden');
    }
    else { // map
      cBlock.classList.add('hidden');
      fBlockMain.classList.remove('hidden');
      rBlock.classList.remove('hidden');
      fBlockFilt.classList.add('hidden');
    }
    draw();
  });

  /* title helpers */
  const barTitle =()=>`${qSel.value} (All)`;
  const filtTitle=()=>`${qSel.value} (${cSel.value})`;
  const mapTitle =()=>`${qSel.value} (All) – ${[...selResponses].join(', ')}`;

  /* drawers */
  function drawCountryBar(){
    const q=qSel.value, reps=respFor(q),
          cats=[...selCountries.size?selCountries:cList],
          get=(resp,ct)=>rows.filter(r=>r.Question.trim()===q
                                       &&r.Country.trim()===ct
                                       &&r.Responses.trim()===resp)
                              .filter(r=>true)[0]?.Result||0;
    let series=reps.map((resp,i)=>({
      name:resp,
      color:barColor(i,reps.length),
      data:cats.map(ct=>get(resp,ct))
    }));
    const totals=cats.map((_,i)=>series.reduce((s,ser)=>s+ser.data[i],0));
    const visCats=cats.filter((_,i)=>totals[i]>0);
    series=series.map(ser=>({...ser,data:ser.data.filter((_,i)=>totals[i]>0)}));
    chart=Highcharts.chart('container',{
      chart:{type:'bar'},
      title:{text:barTitle()},
      xAxis:{categories:visCats},yAxis:{min:0,title:{text:'%'}},
      plotOptions:{series:{stacking:'normal'}},series,
      events:{load(){addLogo(this);},redraw(){addLogo(this);}}
    });
  }

  function drawFilterBar(){
    const q=qSel.value,c=cSel.value,reps=respFor(q),
          filters=[...selFilterFilt],
          get=(resp,fl)=>rows.filter(r=>r.Question.trim()===q
                                       &&r.Country.trim()===c
                                       &&r.Filters.trim()===fl
                                       &&r.Responses.trim()===resp)[0]?.Result||0;
    let series=reps.map((resp,i)=>({
      name:resp,
      color:barColor(i,reps.length),
      data:filters.map(fl=>get(resp,fl))
    }));
    const totals=filters.map((_,i)=>series.reduce((s,ser)=>s+ser.data[i],0));
    const vis=filters.filter((_,i)=>totals[i]>0);
    series=series.map(ser=>({...ser,data:ser.data.filter((_,i)=>totals[i]>0)}));
    chart=Highcharts.chart('container',{
      chart:{type:'bar'},
      title:{text:filtTitle()},
      xAxis:{categories:vis},yAxis:{min:0,title:{text:'%'}},
      plotOptions:{series:{stacking:'normal'}},series,
      events:{load(){addLogo(this);},redraw(){addLogo(this);}}
    });
  }

  function drawMap(){
    const q=qSel.value,reps=respFor(q),byC={};
    rows.filter(r=>r.Question.trim()===q).forEach(r=>{
      const ct=r.Country.trim(),resp=r.Responses.trim();
      byC[ct] ??= {tot:0,all:{}};
      if(selResponses.has(resp)) byC[ct].tot+=r.Result;
      byC[ct].all[resp]=r.Result;
    });
    const keys={};Highcharts.maps['custom/europe'].features.forEach(f=>keys[f.properties.name]=f.properties['hc-key']);
    const data=Object.entries(byC).map(([ct,o])=>[
      keys[ct]||ct.slice(0,2).toLowerCase(),o.tot
    ]);
    chart=Highcharts.mapChart('container',{
      chart:{map:'custom/europe'},
      title:{text:mapTitle()},
      series:[{data,joinBy:['hc-key',0]}],
      mapNavigation:{enabled:true},
      events:{load(){addLogo(this);},redraw(){addLogo(this);}}
    });
  }

  function draw(){
    if(chart) chart.destroy();
    if(view==='bar')      drawCountryBar();
    else if(view==='filter') drawFilterBar();
    else                     drawMap();
    enableExports(chart);
  }

  /* initial draw */
  draw();
}});
</script>
</body>
</html>
